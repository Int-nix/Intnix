<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Finder</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f2f2f7;
      color: #333;
    }

    .sidebar {
      width: 220px;
      background: #e5e5ea;
      padding: 15px 10px;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      box-shadow: inset -1px 0 0 rgba(0,0,0,0.05);
    }

    .sidebar div {
      padding: 10px;
      margin-bottom: 6px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .sidebar div:hover {
      background: #d1d1d6;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .breadcrumbs {
      background: #dcdcdc;
      padding: 12px 16px;
      font-size: 14px;
      border-bottom: 1px solid #c0c0c0;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .breadcrumbs span {
      cursor: pointer;
      color: #007aff;
      transition: color 0.2s ease;
    }

    .breadcrumbs span:hover {
      text-decoration: underline;
    }

    .content {
      flex: 1;
      padding: 20px;
      display: grid;
      gap: 20px;
      align-content: start;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      overflow-y: auto;
    }

    .item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: auto;
      background: white;
      padding: 12px 8px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    .item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .icon {
      font-size: 36px;
      margin-bottom: 8px;
      display: block;
    }

    .item-label {
      font-size: 13px;
      word-break: break-word;
      color: #555;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar"></div>
  <div class="main">
    <div class="breadcrumbs" id="breadcrumbs"></div>
    <div class="content" id="contentArea"></div>
  </div>

  <script>
    let currentPath = "/";
    let fs = {};
    let appMeta = {};

    const sidebar = document.getElementById("sidebar");
    const breadcrumbs = document.getElementById("breadcrumbs");
    const content = document.getElementById("contentArea");

    async function loadFS() {
      const data = await window.livebridge.getFileSystem();
      fs = data.fs;
      appMeta = data.appMeta;
      renderFinder(currentPath);
    }

    window.livebridge.on("filesystem-update", (data) => {
      fs = data.fs;
      appMeta = data.appMeta;
      renderFinder(currentPath);
    });

    function renderFinder(path) {
      currentPath = path;
      renderSidebar();
      renderBreadcrumbs();
      renderContent();
    }

    function renderSidebar() {
      sidebar.innerHTML = "<strong>This PC</strong>";
      (fs["/"] || []).forEach(folder => {
        const div = document.createElement("div");
        div.textContent = folder;
        div.onclick = () => renderFinder("/" + folder);
        sidebar.appendChild(div);
      });
    }

    function renderBreadcrumbs() {
      const parts = currentPath.split("/").filter(Boolean);
      let full = "";
      breadcrumbs.innerHTML = "";

      const rootSpan = document.createElement("span");
      rootSpan.textContent = "This PC";
      rootSpan.onclick = () => renderFinder("/");
      breadcrumbs.appendChild(rootSpan);

      parts.forEach(part => {
        full += "/" + part;
        const separator = document.createTextNode(" / ");
        breadcrumbs.appendChild(separator);

        const crumb = document.createElement("span");
        crumb.textContent = part;
        crumb.onclick = () => renderFinder(full);
        breadcrumbs.appendChild(crumb);
      });
    }

    function renderContent() {
      content.innerHTML = "";
      const items = fs[currentPath] || [];
      items.forEach(item => {
        const fullPath = currentPath === "/" ? "/" + item : currentPath + "/" + item;
        const isFolder = fs[fullPath];
        const meta = appMeta[fullPath];

        const div = document.createElement("div");
        div.className = "item";
        div.draggable = true;

        div.ondragstart = (e) => {
          e.dataTransfer.setData("text/plain", JSON.stringify({ name: item, path: currentPath }));
        };

        div.ondragover = (e) => e.preventDefault();

        div.ondrop = (e) => {
          e.preventDefault();
          const dragged = JSON.parse(e.dataTransfer.getData("text/plain"));
          window.livebridge.moveFile({
            from: dragged.path,
            file: dragged.name,
            to: fullPath
          });
        };

        let icon = "📄";
        let handler = () => alert("Open: " + item);

        if (isFolder) {
          icon = "📁";
          handler = () => renderFinder(fullPath);
        } else if (item.endsWith(".html")) {
          icon = "🌐";
          handler = () => window.livebridge.launchApp(fullPath);
        } else if (item.endsWith(".txt")) {
          icon = "📝";
          handler = () => window.livebridge.openTextEditor(fullPath);
        }

        div.innerHTML = `<div class='icon'>${icon}</div><div class='item-label'>${item}</div>`;
        div.onclick = handler;
        content.appendChild(div);
      });
    }

    loadFS();
  </script>
</body>
</html>
